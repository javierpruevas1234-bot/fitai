async function analyzePlan() {
    const f = document.getElementById('plan-file').files[0]; 
    if(!f) return;
    
    setLog("⏳ LEYENDO DIETA...", "yellow");
    const b64 = await toBase64(f);
    
    try {
        // Usamos gemini-2.0-flash que es la versión estable para tu cuenta
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}`, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                contents: [{ 
                    parts: [
                        { text: "Extrae la dieta en JSON (lunes a domingo). Formato: {'lunes':[{tipo:'Desayuno', menu:'...', kcal:num, p:num, c:num, f:num},...], ...}. Solo JSON puro." },
                        { inline_data: { mime_type: "image/jpeg", data: b64.split(',')[1] } }
                    ]
                }] 
            })
        });

        const d = await res.json();
        if(d.error) throw new Error(d.error.message);

        // Esta es la parte clave: extrae el JSON aunque haya texto alrededor
        const rawText = d.candidates[0].content.parts[0].text;
        myPlan = JSON.parse(rawText.match(/\{.*\}/s)[0]);
        
        localStorage.setItem('fit_plan', JSON.stringify(myPlan));
        setLog("✅ DIETA CARGADA", "p"); 
        update();
        
    } catch (e) { 
        setLog("❌ ERROR: " + e.message, "red"); 
    }
}
